<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout">
<head>
    <title>Job Post List</title>
    <link th:href="@{/static/bower_components/bootstrap-table/dist/bootstrap-table.min.css}" rel="stylesheet" media="screen" type="text/css"/>
    <script type="text/javascript" th:src="@{/static/bower_components/bootstrap-table/dist/bootstrap-table.js}"></script>
    <script type="text/javascript" th:src="@{/static/bower_components/bootstrap-table/dist/extensions/cookie/bootstrap-table-cookie.min.js}"></script>
</head>
<body>

<div layout:fragment="content">
    <style>
        .th-inner {
            font-weight: normal;
            font-style: italic;
        }
    </style>
    <div class="row" id="page">
        <h3><a v-if="jobApplication" data-toggle="modal" data-target="#job-post-modal"  data-id="{{ jobApplication.jobPost.id }}" title="preview" style="cursor: pointer;"><i class="fa fa-eye" aria-hidden="true"></i></a>Job Post Info </h3>
        <div th:replace="career/applicant_profile :: applicant_profile"></div>
        <h3>Review Detail</h3>
        <h4 id="notice">{{ notice }}</h4>

        <table id="table"
               data-toolbar="#toolbar"
               data-show-header="false"
               data-show-refresh="true"
               data-show-toggle="true"
               data-pagination="true"
               data-side-pagination="server"
               data-page-list="[ALL]"
               data-detail-view="true"
               data-id-field="id"
               smartDisplay="true"
               style="word-wrap: break-word">
        </table>

        <div v-if="myRunStatus == 1 &amp;&amp; !responseSubmitted" role="form">
            <div class="form-group">
                <label for="response" class="control-label">Your comment for run {{ myRun.runNumber }}: {{ myRun.task }}</label>
                <textarea class="form-control" id="response" rows="5"></textarea>
            </div>
            <div class="form-group">
                <button class="btn btn-success" id="pass" onclick="submitResponse('PASSED')">Pass</button>
                <button class="btn btn-danger" id="fail" onclick="submitResponse('FAILED')">Fail</button>
            </div>
        </div>
        <div th:replace="career/career_job_post :: job_post_modal"></div>
    </div>

    <script type="text/javascript" th:inline="javascript">
        //<![CDATA[
        var $table = $('#table');

        var vm = new Vue({
            el: '#page',
            data: {
                jobApplication: null,
                myResponse: null,
                myRun: null,
                myRunStatus: 0,
                hasRun: false,
                notice: null,
                responseSubmitted: false
            },
        })

        jQuery(document).ready(function ($) {
            initTable();
        });

        function initTable() {
            $table.bootstrapTable({
                columns: [{
                    formatter: function (index, row, element) { // one row is one reviewRun
                        return "Run " + row.runNumber + ": " + row.task;
                    },
                    width: "3000"
                }],
                url: '/api/job_application/' + window.location.pathname.split("/")[2],
                contentType: "application/x-www-form-urlencoded",
                queryParamsType: "limit",
                queryParams: function (p) {
                    var data = {};
                    if (p.sort) {
                        data.sort = p.sort;
                    } else {
                        data.sort = "lastModifiedDate";
                    }
                    data.order = p.order;
                    data.limit = p.limit;
                    data.offset = p.offset;
                    data.filter = p.filter;
                    return data;
                },
                responseHandler: function (res) {
                    vm.jobApplication = res;

                    if (vm.jobApplication.status == "REVIEWING") {
                        setMyRunStatus();
                        if (vm.hasRun) {
                            if (vm.myRunStatus == 1) {
                                vm.notice = "It's your turn now"
                            } else if (vm.myRunStatus == -1) {
                                vm.notice = "You have finished your turn"
                            } else {
                                vm.notice = "It's not your turn yet"
                            }
                        }
                    } else {
                        vm.notice = "Application status: " + vm.jobApplication.status
                    }

                    var uid = vm.jobApplication.applicant.id;
                    initFileListTable(uid);
                    loadContactForm("/api/user/profile/" + uid);

                    var data = {};
                    if (res.jobPost.reviewFlow) {
                        data.rows = res.jobPost.reviewFlow.runs;
                        data.total = res.jobPost.reviewFlow.runs.length;
                    }
                    return data;
                },
                rowStyle: function rowStyle(value, row, index) {
                    return {
                        css: {"font-weight": "bolder"}
                    }
                },
                onExpandRow: function(index, row, $detail) { // one row is one reviewRun
                    $detail.html('<table></table>').find('table').bootstrapTable({
                        columns: [{
                            field: 'reviewer',
                            title: 'Reviewer',
                            width:"15%",
                            formatter: function (index, row, element) {
                                if (vm.myRunStatus == 1 && index.id == vm.myResponse.reviewer.id && row.reviewRun.id == vm.myRun.id) {
                                    return '<b>' + index.name + '</b>';
                                }
                                return index.name;
                            },
                        }, {
                            field: 'response',
                            title: 'Comment',
                            formatter: function (index, row, element) { // one row is one reviewResponse
                                if (index) {
                                    return index;
                                }
                            },
                            cellStyle: function (value, row, index) {
                                return {
                                    css: {"max-width": "100px"}
                                };
                            }
                        }, {
                            field: 'status',
                            title: 'Status',
                            width:"10%",
                        }],
                        data: getResponsesOfRun(row.runNumber),
                    });
                },
                onLoadSuccess: function () {
                    $table.bootstrapTable('expandAllRows', false);
                },
                cookie: true,
                cookieIdTable: 'review_run',
            });

        }

        function getResponsesOfRun(runNumber) {
            var responses = [];
            $.each(vm.jobApplication.responses, function( i, v ) {
                if (v.reviewRun.runNumber == runNumber) {
                    responses.push(v);
                }
            });
            return responses;
        }
        function setMyTurn() {
            $.each(vm.jobApplication.responses, function( i, v ) {
                if (v.reviewer.id == currentUser.id) {
                    vm.hasRun = true;
                    if (!vm.myRun || v.reviewRun.runNumber < vm.myRun.runNumber) {
                        if (v.status != "REVIEWING") {
                            vm.myRun = null
                        } else {
                            vm.myRun = v.reviewRun;
                            vm.myResponse = v;
                        }
                    }
                }
            });
        }
        function setMyRunStatus() {
            setMyTurn();
            if (!vm.myRun) {
                vm.myRunStatus = -1;
                return
            }
            if (vm.myRun.runNumber == 1) {
                vm.myRunStatus = 1;
                return
            }
            var result = true;
            var responses = getResponsesOfRun(vm.myRun.runNumber - 1);
            $.each(responses, function( i, v ) {
                if (v.status == "REVIEWING") {
                    result = false;
                }
            });
            vm.myRunStatus = result ? 1 : 0;
            return;
        }
        function submitResponse(status) {
            vm.myResponse.response = $("#response").val();
            vm.myResponse.status = status;

            $.ajax({
                type: "put",
                url: "/api/review_flow/" + vm.jobApplication.id,
                data: JSON.stringify(vm.myResponse),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    vm.responseSubmitted = true;
                    $table.bootstrapTable('refresh');
                }
            });
        }


        //]]>
    </script>
</div>
</body>
</html>